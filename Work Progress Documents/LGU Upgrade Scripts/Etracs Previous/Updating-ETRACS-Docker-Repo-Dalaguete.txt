===================================
 Updating ETRACS Docker Repository
===================================

Keywords: 

   <User>       - User name of your ubuntu server 
                    usr:itsm
                    pwd:dalaguete

   <ServerIP>   - IP address of your ubuntu server
                    ip:192.168.11.18

   <Samba-Pass> - Samba Share password. 
                  The default value is  p@ssw0rd



Open "Git Bash" terminal and login to the server via SSH

$  ssh <User>@<ServerIP>



01. Duplicate the docker folder 

    $  cd 
    
    $  cp  -rvfp  docker  docker-new 


02. Pull updates from GitHub

    $  cd ~/docker-new
    
    $  git pull


    NOTE: Credentials to be used in pulling updates 

          User: etracslgurepo
          Pass: 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


03. Pull updates from DockerHub

    $  cd ~/docker-new/bin
    
    $  sh update-docker-images.sh


04. Open the file "env.conf"

    $  cd ~/docker-new/_custom

    $  nano env.conf


05. Add the following settings if not yet added
    or update the existing settings


channel=04321
channelgroup=etracscebu
fileupload_channel=${channel}
filipizen_group=cebu_dalaguete

sms_acctname=04321
sms_apikey=bede3c977b3d61d05f6533b91874c6df



06. Save and close the nano editor


Now the "docker-new" repo folder is fully updated.
We will now switched the new folder as your main folder.

But first inform everyone to close their ETRACS client 
in preparation for the upgrade procedure. 


07. Stop all containers from the old docker 

    $  cd ~/docker/bin
    
    $  sh stop-gdx.sh
    
    $  sh stop.sh


08. Rename the old docker according to your preferred name 

    $  cd
    
    $  mv docker  docker-old-2023-05-17


09. Rename the new docker folder as "docker"

    $  cd
    
    $  mv docker-new  docker



The "docker" repo folder is now ready but before running it, 
we will execute the upgrade scripts for your etracs database.

But first, let us mount the docker folder to your windows drive, 
specifically to Drive Z, but you can change the drive letter 
if your Z drive is already in used. 


10. Open a Command Prompt console and execute the command:

    net use z: \\<ServerIP>\<User>  /user:<User> <Samba-Pass>


11. Open your Navicat client and do the following:  

    11.01  Open your etracs main database 
    
    11.02  Open a new Query window 
    
    11.03  Click "Load" or press "CTRL + O" 
    
    11.04  Browse to folder "z:/docker/_res/_upgrade" 
    
    11.05  Select a file sequentially according to its number prefix 
    
    11.06  Repeat Step-14.03 for the next file to execute


Now the database has been upgraded, 
we will now start the docker containers.


12. Switched back to your Git Bash session

13. Run the containers

    $  cd ~/docker/bin
    
    $  sh start.sh


14. Run GDX container

    $  sh restart-gdx.sh


    NOTE: You may press CTRL + C 
          when you see colored text messages 
          in the console log to exit from the 
          blocking processed.


15. Monitor the status and logs via Portainer

16. Inform everyone that they can now open 
    an ETRACS client and login.


DONE !!!
